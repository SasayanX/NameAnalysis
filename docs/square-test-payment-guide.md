# Squareテスト決済ガイド

## 🔒 重要: テスト決済ではお金は引き落とされません

### ✅ サンドボックス（テスト）環境

**Squareのサンドボックス環境では、実際のお金は一切引き落とされません。**

- ✅ テストカードを使用可能
- ✅ 実際の引き落としなし
- ✅ 無料でテスト可能
- ✅ 何度でも試せる

### ⚠️ 本番環境

**本番環境では実際のお金が引き落とされます。**

- ⚠️ 実際のカード情報が必要
- ⚠️ 実際のお金が引き落とされる
- ⚠️ キャンセルが必要な場合がある

## 🧪 テスト決済の方法

### 方法1: Squareサンドボックス環境でテスト

1. **Square Developer Dashboard**にアクセス
   - https://developer.squareup.com/apps

2. **サンドボックス環境**を選択
   - ダッシュボード上部の「Sandbox」を選択

3. **テストカードを使用**
   ```
   カード番号: 4111 1111 1111 1111
   有効期限: 任意の未来の日付（例: 12/25）
   CVV: 任意の3桁（例: 123）
   郵便番号: 任意（例: 12345）
   ```

4. **テスト決済を実行**
   - 実際のお金は引き落とされません
   - 決済処理は成功しますが、実際の取引は発生しません

### 方法2: テストモードでPayment Linkを作成

1. **Squareダッシュボード > オンライン決済 > 支払いリンク**
2. **「テストモード」**でリンクを作成
3. テストカードで決済をテスト

## 🚫 テスト決済のキャンセル方法

### サンドボックス環境の場合

**サンドボックス環境では、キャンセルは不要です。**

- 実際のお金は引き落とされていないため
- テストサブスクリプションは自動的に無効化されます
- 何もする必要はありません

### もし本番環境で誤って決済してしまった場合

#### 方法1: Squareダッシュボードでキャンセル

1. **Squareダッシュボードにログイン**
2. **顧客 > サブスクリプション** に移動
3. 該当のサブスクリプションを選択
4. **「キャンセル」** をクリック
5. 即座にキャンセルされます

#### 方法2: APIでキャンセル

```bash
curl -X POST https://connect.squareup.com/v2/subscriptions/{subscription_id}/cancel \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

#### 方法3: 返金申請

1. **Squareダッシュボード > 決済 > 取引履歴**
2. 該当の取引を選択
3. **「返金」** をクリック
4. 返金理由を入力
5. 返金が処理されます（通常1-3営業日）

## 🔍 環境の確認方法

### 現在の環境を確認

1. **Squareダッシュボード**にアクセス
2. 右上の環境表示を確認
   - **「Sandbox」** → テスト環境（お金は引き落とされない）
   - **「Production」** → 本番環境（実際のお金が引き落とされる）

### 環境変数で確認

```env
# サンドボックス環境（テスト）
SQUARE_ACCESS_TOKEN=sandbox-sq0atb-xxxxx  # "sandbox-"で始まる
SQUARE_APPLICATION_ID=sandbox-sq0idb-xxxxx  # "sandbox-"で始まる

# 本番環境
SQUARE_ACCESS_TOKEN=sq0atp-xxxxx  # "sandbox-"で始まらない
SQUARE_APPLICATION_ID=sq0idp-xxxxx  # "sandbox-"で始まらない
```

## ✅ 安全にテストするためのチェックリスト

### テスト前に確認

- [ ] Squareダッシュボードで「Sandbox」環境が選択されている
- [ ] 環境変数に `sandbox-` が含まれている
- [ ] テストカード（4111 1111 1111 1111）を使用する
- [ ] 本番環境の認証情報を使っていない

### テスト中

- [ ] テストカードのみを使用
- [ ] 実際のカード情報を入力しない
- [ ] 決済金額が正しいか確認

### テスト後

- [ ] サンドボックス環境では何もする必要はない
- [ ] テストサブスクリプションは自動的に無効化される

## 🚨 注意事項

### 本番環境で誤って決済してしまった場合

1. **即座にSquareダッシュボードでキャンセル**
   - サブスクリプションは即座にキャンセル可能
   - 返金が必要な場合は返金申請

2. **返金期間**
   - 通常1-3営業日で返金が処理されます
   - カード会社によっては数日かかる場合があります

3. **返金手数料**
   - Squareは返金手数料を請求しません
   - ただし、決済手数料は返金されません（通常3.25%）

### テスト環境と本番環境の切り替え

**重要**: テスト環境と本番環境では、認証情報が異なります。

- **サンドボックス**: `sandbox-` で始まる認証情報
- **本番**: `sandbox-` で始まらない認証情報

環境変数を切り替える際は、必ず確認してください。

## 📝 まとめ

### ✅ 安全なテスト方法

1. **サンドボックス環境を使用**
   - 実際のお金は引き落とされない
   - テストカード（4111 1111 1111 1111）を使用
   - 何度でも試せる

2. **本番環境では注意**
   - 実際のお金が引き落とされる
   - 決済前に必ず確認
   - 誤って決済した場合は即座にキャンセル

### 🎯 推奨テストフロー

1. **開発環境**: サンドボックス環境でテスト
2. **動作確認**: テストカードで決済をテスト
3. **本番デプロイ**: 本番環境にデプロイ
4. **本番テスト**: 小額でテスト（例: 1円）
5. **本格運用**: 通常の価格で運用開始

これで安全にテストできます！

