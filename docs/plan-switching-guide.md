# プラン切り替えガイド

## ⚠️ 重要: 本番環境では無効化されています

この機能は**開発環境でのみ動作**します。本番環境ではセキュリティのため無効化されています。

## 🔄 プランを切り替える方法（開発環境のみ）

URLパラメータを使ってプランを切り替えることができます。

### 基本的な使い方

```
/?plan=free    → 無料プランに戻す
/?plan=basic   → ベーシックプランに切り替え
/?plan=premium → プレミアムプランに切り替え
```

### 使用例

#### 無料プランに戻す

現在ベーシックプランやプレミアムプランを使っている場合、以下のURLにアクセスすると無料プランに戻ります：

```
http://localhost:3000/?plan=free
```

または

```
https://your-domain.com/?plan=free
```

#### ベーシックプランに切り替え

```
http://localhost:3000/?plan=basic
```

#### プレミアムプランに切り替え

```
http://localhost:3000/?plan=premium
```

## ⚠️ 注意事項

### 開発環境でのみ動作

この機能は**開発環境でのみ動作**します。本番環境では自動的に無効化されます。

**動作条件**:
- `NODE_ENV === "development"` の場合
- `localhost` または `127.0.0.1` でアクセスしている場合
- `NEXT_PUBLIC_ALLOW_PLAN_PARAM=true` が設定されている場合（推奨しません）

**本番環境では**:
- URLパラメータは自動的に削除されます
- プランの切り替えは行われません
- セキュリティが保護されます

### 実際の決済とは無関係

URLパラメータでプランを切り替えても、実際のSquare決済とは無関係です。

- 実際の決済をキャンセルするには、Squareダッシュボードで手動でキャンセルする必要があります
- URLパラメータでの切り替えは、アプリ内の表示と機能制限のみを変更します

### 無料プランに戻す場合

無料プランに戻すと：
- ✅ プランが「無料」に設定されます
- ✅ 機能制限が無料プランの制限に戻ります
- ✅ 実際のSquare決済はキャンセルされません（手動でキャンセルが必要）

## 🔧 動作の仕組み

1. URLパラメータ `?plan=free` が検出される
2. `localStorage` に無料プランの情報を保存
3. ページがリロードされる
4. `SubscriptionManager` が `localStorage` から読み込んでプランを適用

## 📝 実装詳細

### コードの場所

`app/ClientPage.tsx` の `useEffect` フックで処理されています。

### 処理フロー

```
URLパラメータ検出
  ↓
既存のプラン確認
  ↓
プランが異なる場合のみ更新
  ↓
localStorageに保存
  ↓
URLパラメータを削除
  ↓
ページをリロード
```

## ✅ 確認方法

プランが正しく切り替わったか確認する方法：

1. **ブラウザの開発者ツールを開く**
2. **Console** タブを開く
3. **Application** タブ > **Local Storage** を開く
4. **`userSubscription`** キーを確認
5. **`plan`** フィールドが `"free"`, `"basic"`, または `"premium"` になっているか確認

## 🚨 トラブルシューティング

### プランが切り替わらない場合

1. **ページをリロード**してください（`F5` または `Ctrl+R`）
2. **ブラウザのキャッシュをクリア**してください
3. **URLパラメータが正しいか確認**してください（`?plan=free` など）

### 無料プランに戻らない場合

1. **`/?plan=free`** にアクセス
2. **ページがリロードされるまで待つ**
3. **`localStorage` を確認**して `plan: "free"` になっているか確認

## 💡 補足

### Square決済のキャンセル

URLパラメータでプランを切り替えても、実際のSquare決済は自動的にキャンセルされません。

実際の決済をキャンセルするには：
1. Squareダッシュボードにログイン
2. **顧客 > サブスクリプション** に移動
3. 該当のサブスクリプションを選択
4. **「キャンセル」** をクリック

### 開発環境でのテスト

開発環境では、この機能を使って簡単にプランを切り替えてテストできます：

```bash
# 無料プランでテスト
http://localhost:3000/?plan=free

# ベーシックプランでテスト
http://localhost:3000/?plan=basic

# プレミアムプランでテスト
http://localhost:3000/?plan=premium
```

これで簡単にプランを切り替えられます！

